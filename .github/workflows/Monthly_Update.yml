name: Monthly Drug Database Update

on:
  schedule:
    # 매월 1일 00:00 UTC (한국 시간 오전 9:00) 실행
    - cron: '0 0 1 * *'
  workflow_dispatch: # 수동 실행 버튼

permissions:
  contents: write

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pandas openpyxl

      - name: Run update script
        # 1. 엑셀 파일이 있으면 그걸로 변환하고 삭제함 (이번 달 수동 업데이트)
        # 2. 엑셀 파일이 없으면 API로 다운로드 시도 (다음 달 자동 업데이트)
        env:
          DATA_API_KEY: ${{ secrets.DATA_API_KEY }}
          PYTHONUNBUFFERED: "1"
        run: |
          if [ -f "scripts/data.xlsx" ]; then
            echo ">> [Mode: Manual] Found 'scripts/data.xlsx'. Converting to JSON..."
            python -u scripts/import_excel.py
            
            # 다음 달 자동화를 위해 사용한 엑셀 파일 삭제 표시
            echo "DELETE_EXCEL=true" >> $GITHUB_ENV
          else
            echo ">> [Mode: Auto] No Excel file found. Attempting API Download..."
            python -u scripts/update_db.py
          fi

      - name: Commit and push changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # 1. 생성된 JSON 파일 추가
          git add -f public/drugs.json
          
          # 2. 만약 엑셀을 썼다면, 저장소에서 삭제 (다음 달엔 API를 쓰기 위함)
          if [ "$DELETE_EXCEL" == "true" ]; then
            echo ">> Removing used Excel file from repository..."
            git rm -f scripts/data.xlsx || true
            COMMIT_MSG="Manual Update: Imported Excel & Updated DB"
          else
            COMMIT_MSG="Monthly Update: Synced via API"
          fi
          
          # 3. 변경사항 커밋 및 푸시
          git diff --quiet && git diff --staged --quiet || (git commit -m "$COMMIT_MSG" && git push)
